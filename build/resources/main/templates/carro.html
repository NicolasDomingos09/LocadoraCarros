<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-br">
<head th:replace="~{head :: head('Carros')}"></head>
<header th:replace="~{header_admin :: header(activePage='carros')}"></header>
<body>
<div class="container d-flex flex-column align-items-center justify-content-center mt-5">
    <form th:action="@{/carro}" method="post" th:object="${carro}" class="w-75" enctype="multipart/form-data">
        <!--mvc hidden method filter-->
        <input type="hidden" name="_method" value="put">

        <!--Listar-->
        <button type="submit" th:formaction="@{/carro/listar}" formmethod="get"
                class="btn botao-azul mb-3 w-100">Listar Carros
        </button>

        <div class="row">
            <div class="col-md-6">
                <div class="input-group mb-3">
                    <span class="input-group-text">Placa</span>
                    <input th:field="*{placa}" class="form-control" placeholder="Placa do carro">
                </div>

                <div class="input-group mb-3">
                    <span class="input-group-text">Marca</span>
                    <input th:field="*{marca}" class="form-control" placeholder="Marca do carro">
                </div>

                <div class="input-group mb-3">
                    <span class="input-group-text">Modelo</span>
                    <input th:field="*{modelo}" class="form-control" placeholder="Modelo do carro">
                </div>

                <div class="input-group mb-3">
                    <span class="input-group-text">Cor</span>
                    <input th:field="*{cor}" class="form-control" placeholder="Cor do carro">
                </div>

                <div class="input-group mb-3">
                    <span class="input-group-text">Ano</span>
                    <input th:field="*{ano}" class="form-control" placeholder="Ano do carro">
                </div>
            </div>
            <div class="col-md-6">
                <div class="input-group mb-3">
                    <span class="input-group-text">Tipo de Combustível</span>
                    <select th:field="*{tipoCombustivel}" class="form-select">
                        <option value="">Selecione o tipo de combustível</option>
                        <option value="Gasolina">Gasolina</option>
                        <option value="Etanol">Etanol</option>
                        <option value="Diesel">Diesel</option>
                        <option value="Flex">Flex</option>
                        <option value="Eletrico">Elétrico</option>
                        <option value="Hibrido">Híbrido</option>
                    </select>
                </div>

                <div class="input-group mb-3">
                    <span class="input-group-text">Quilometragem</span>
                    <input th:field="*{quilometragem}" class="form-control" placeholder="Quilometragem do carro">
                </div>

                <div class="input-group mb-3">
                    <span class="input-group-text">Tipo de Câmbio</span>
                    <select th:field="*{tipoCambio}" class="form-select">
                        <option value="">Selecione o tipo de câmbio</option>
                        <option value="Manual">Manual</option>
                        <option value="Automatico">Automático</option>
                    </select>
                </div>

                <div class="input-group mb-3">
                    <span class="input-group-text">Categoria</span>
                    <select th:field="*{categoria}" class="form-select">
                        <option value="">Selecione uma categoria</option>
                        <option th:each="cat : ${categorias}"
                                th:value="${cat.id}"
                                th:text="${cat.descricao}">
                        </option>
                    </select>
                </div>

                <div class="input-group mb-3">
                    <input type="file" name="imagem" class="form-control" placeholder="Imagem do carro">
                </div>
            </div>
        </div>

        <!--Exibe a imagem do carro (se existir)-->
        <div th:if="${carro.imagemPath}" class="mb-3 text-center">
            <img th:src="@{${carro.imagemPath}}" width="400" alt="Imagem do carro" class="img-thumbnail"/>
        </div>

        <!--Botões-->
        <div class="d-flex gap-2 mt-3">
            <!-- PUT -->
            <button type="submit" class="btn botao-azul w-100"
                    onclick="this.form._method.value='put'">
                Atualizar
            </button>

            <!-- POST -->
            <button type="submit" class="btn botao-azul w-100"
                    onclick="this.form._method.value='post'">
                Salvar
            </button>
        </div>

        <div th:if="mensagem != null">
            <h5 th:text="${mensagem}" class="mx-3 text-center"></h5>
        </div>
    </form>

    <!--Listagem-->
    <div class="container d-flex align-items-center justify-content-center" th:if="${carros.size() > 0}">
        <div class="card mx-3 my-3" style="width: 100%;">
            <div class="card-body">
                <table class="table table-striped table-hover">
                    <thead>
                    <tr>
                        <th>Placa</th>
                        <th>Marca</th>
                        <th>Modelo</th>
                        <th>Cor</th>
                        <th>Ano</th>
                        <th>Tipo de combustível</th>
                        <th>Quilometragem</th>
                        <th>Tipo de câmbio</th>
                        <th>Categoria</th>
                        <th>Ações</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="carro : ${carros}">
                        <td th:text="${carro.placa}"></td>
                        <td th:text="${carro.marca}"></td>
                        <td th:text="${carro.modelo}"></td>
                        <td th:text="${carro.cor}"></td>
                        <td th:text="${carro.ano}"></td>
                        <td th:text="${carro.tipoCombustivel}"></td>
                        <td th:text="${carro.quilometragem}"></td>
                        <td th:text="${carro.tipoCambio}"></td>
                        <td th:text="${carro.categoria.descricao}"></td>
                        <td>
                            <!--Editar-->
                            <a th:href="@{'/carro/' + ${carro.placa}}" title="Editar Carro">
                                <i class="fa-regular fa-pen-to-square" style="color: black"></i>
                            </a>

                            &nbsp;

                            <!-- Botão Delete que abre o modal -->
                            <a href="#"
                               title="Excluir Carro"
                               data-bs-toggle="modal"
                               data-bs-target="#confirmDeleteModal"
                               th:data-placa="${carro.placa}">
                                <i class="fa-regular fa-trash-can" style="color: black"></i>
                            </a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Tem certeza de que deseja excluir este carro? Esta ação não pode ser desfeita.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn botao-azul" data-bs-dismiss="modal">Cancelar</button>
                <!-- Formulário de exclusão dentro do modal -->
                <form id="deleteForm" method="post" th:action="@{/carro/}" style="display: inline;">
                    <input type="hidden" name="_method" value="delete">
                    <button type="submit" class="btn btn-danger">Excluir</button>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
    const confirmDeleteModal = document.getElementById('confirmDeleteModal');
    confirmDeleteModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const placa = button.getAttribute('data-placa');
        const deleteForm = document.getElementById('deleteForm');
        const baseAction = deleteForm.getAttribute('action');
        deleteForm.action = baseAction + placa;
    });
</script>

</body>
</html>